<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©sultats - Classification de Documents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }
        .chart-container-small {
            position: relative;
            height: 180px;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="mb-6">
            <a href="/" class="text-blue-600 hover:text-blue-700 mb-4 inline-block">‚Üê Retour</a>
            <h1 class="text-3xl font-bold text-gray-900">R√©sultats de Classification</h1>
        </header>

        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 text-gray-600">Chargement des r√©sultats...</p>
        </div>

        <div id="results-content" class="hidden">
            <!-- Verdict Final -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl shadow-lg p-6 mb-6 text-white">
                <h2 class="text-xl font-semibold mb-4">Verdict Final</h2>
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <p class="text-blue-200 text-sm mb-1">Niveau 1</p>
                        <p class="text-2xl font-bold" id="final-level1">-</p>
                    </div>
                    <div>
                        <p class="text-blue-200 text-sm mb-1">Niveau 2</p>
                        <p class="text-2xl font-bold" id="final-level2">-</p>
                    </div>
                    <div>
                        <p class="text-blue-200 text-sm mb-1">Confiance</p>
                        <div class="flex items-center gap-3">
                            <div class="flex-1 bg-blue-900 rounded-full h-3 overflow-hidden">
                                <div id="confidence-bar" class="bg-green-400 h-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <span id="confidence-text" class="text-xl font-bold">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content Grid -->
            <div class="grid lg:grid-cols-2 gap-6 mb-6">
                <!-- Document Preview -->
                <div class="bg-white rounded-xl shadow-lg p-5">
                    <h3 class="text-lg font-semibold mb-3">Document</h3>
                    <div class="flex justify-center">
                        <img id="preview-img" class="max-w-full max-h-64 rounded-lg shadow" alt="Preview">
                    </div>
                </div>

                <!-- Models Confidence Chart -->
                <div class="bg-white rounded-xl shadow-lg p-5">
                    <h3 class="text-lg font-semibold mb-3">Confiance par Mod√®le</h3>
                    <div class="chart-container">
                        <canvas id="models-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Evidence Cards -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <!-- VLM -->
                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-blue-500">
                    <h4 class="font-semibold text-blue-600 mb-2">ü§ñ VLM (Qwen2-VL)</h4>
                    <div id="vlm-evidence" class="text-sm">
                        <p class="text-gray-500">En attente...</p>
                    </div>
                </div>

                <!-- ORB -->
                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-green-500">
                    <h4 class="font-semibold text-green-600 mb-2">üîç ORB</h4>
                    <div id="orb-evidence" class="text-sm">
                        <p class="text-gray-500">En attente...</p>
                    </div>
                </div>

                <!-- RoBERTa -->
                <div class="bg-white rounded-xl shadow p-4 border-l-4 border-purple-500">
                    <h4 class="font-semibold text-purple-600 mb-2">üìù RoBERTa</h4>
                    <div id="roberta-evidence" class="text-sm">
                        <p class="text-gray-500">En attente...</p>
                    </div>
                </div>
            </div>

            <!-- Top Classes Chart -->
            <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
                <h3 class="text-lg font-semibold mb-3">Distribution des Classes</h3>
                <div class="chart-container-small">
                    <canvas id="top-classes-chart"></canvas>
                </div>
            </div>

            <!-- PDF Pages (si applicable) -->
            <div id="pages-section" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-5 mb-6">
                    <h3 class="text-lg font-semibold mb-3">Confiance par Page</h3>
                    <div class="chart-container-small">
                        <canvas id="pages-chart"></canvas>
                    </div>
                </div>
                <div id="pages-details">
                    <h3 class="text-lg font-semibold mb-3">D√©tails par Page</h3>
                    <div id="pages-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let results = null;
        let fileId = null;

        window.addEventListener('DOMContentLoaded', () => {
            const resultsJson = sessionStorage.getItem('classificationResults');
            fileId = sessionStorage.getItem('fileId');

            if (!resultsJson || !fileId) {
                document.getElementById('loading').innerHTML = '<p class="text-red-600">Aucun r√©sultat trouv√©. <a href="/" class="underline">Retour</a></p>';
                return;
            }

            try {
                results = JSON.parse(resultsJson);
                displayResults();
            } catch (e) {
                console.error('Error parsing results:', e);
                document.getElementById('loading').innerHTML = '<p class="text-red-600">Erreur de parsing. <a href="/" class="underline">Retour</a></p>';
            }
        });

        function displayResults() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('results-content').classList.remove('hidden');

            // Verdict final
            document.getElementById('final-level1').textContent = results.final_level1 || 'N/A';
            document.getElementById('final-level2').textContent = results.final_level2 || 'N/A';
            const confidence = (results.final_confidence || 0) * 100;
            document.getElementById('confidence-text').textContent = confidence.toFixed(0) + '%';
            document.getElementById('confidence-bar').style.width = confidence + '%';

            // Preview image
            document.getElementById('preview-img').src = `${API_BASE}/file/${fileId}`;

            // Evidence
            displayEvidence();

            // Charts
            createModelsChart();
            createTopClassesChart();

            // PDF pages
            if (results.is_pdf && results.pages && results.pages.length > 1) {
                document.getElementById('pages-section').classList.remove('hidden');
                createPagesChart();
                displayPagesDetails();
            }
        }

        function displayEvidence() {
            const firstPage = results.pages && results.pages[0] ? results.pages[0] : results;

            // VLM
            const vlmDiv = document.getElementById('vlm-evidence');
            if (firstPage?.vlm_level1) {
                const vlm = firstPage.vlm_level1;
                vlmDiv.innerHTML = `
                    <p class="mb-1"><span class="text-gray-500">Classe:</span> <strong>${vlm.class || 'N/A'}</strong></p>
                    <p class="mb-1"><span class="text-gray-500">Confiance:</span> <strong>${((vlm.confidence || 0) * 100).toFixed(0)}%</strong></p>
                    <p class="text-xs text-gray-400">Temps: ${(vlm.elapsed || 0).toFixed(2)}s</p>
                `;
            } else {
                vlmDiv.innerHTML = '<p class="text-red-400">Non disponible</p>';
            }

            // ORB
            const orbDiv = document.getElementById('orb-evidence');
            if (firstPage?.orb) {
                const orb = firstPage.orb;
                orbDiv.innerHTML = `
                    <p class="mb-1"><span class="text-gray-500">Classe:</span> <strong>${orb.class || 'N/A'}</strong></p>
                    <p class="mb-1"><span class="text-gray-500">Confiance:</span> <strong>${((orb.confidence || 0) * 100).toFixed(0)}%</strong></p>
                    <p class="text-xs text-gray-400">Temps: ${(orb.elapsed || 0).toFixed(2)}s</p>
                `;
            } else {
                orbDiv.innerHTML = '<p class="text-gray-400">Non utilis√©</p>';
            }

            // RoBERTa
            const robertaDiv = document.getElementById('roberta-evidence');
            if (firstPage?.roberta) {
                const roberta = firstPage.roberta;
                robertaDiv.innerHTML = `
                    <p class="mb-1"><span class="text-gray-500">Classe:</span> <strong>${roberta.class || 'N/A'}</strong></p>
                    <p class="mb-1"><span class="text-gray-500">Confiance:</span> <strong>${((roberta.confidence || 0) * 100).toFixed(0)}%</strong></p>
                    <p class="text-xs text-gray-400">Temps: ${(roberta.elapsed || 0).toFixed(2)}s</p>
                `;
            } else {
                robertaDiv.innerHTML = '<p class="text-gray-400">Pas de texte OCR</p>';
            }
        }

        function createModelsChart() {
            const firstPage = results.pages && results.pages[0] ? results.pages[0] : results;
            if (!firstPage) return;

            const ctx = document.getElementById('models-chart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['VLM', 'ORB', 'RoBERTa'],
                    datasets: [{
                        data: [
                            (firstPage.vlm_level1?.confidence || 0) * 100,
                            (firstPage.orb?.confidence || 0) * 100,
                            (firstPage.roberta?.confidence || 0) * 100
                        ],
                        backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, usePointStyle: true }
                        }
                    }
                }
            });
        }

        function createTopClassesChart() {
            const firstPage = results.pages && results.pages[0] ? results.pages[0] : null;
            if (!firstPage) return;

            const ctx = document.getElementById('top-classes-chart');
            if (!ctx) return;

            const classes = ['CIN', 'DOC EMPLOYEUR', 'FACTURE', 'RELEVE BANCAIRE'];
            const fullClasses = ['CIN', 'DOCUMENT EMPLOYEUR', 'FACTURE D\'EAU ET D\'ELECTRICITE', 'RELEVE BANCAIRE'];
            const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6'];
            
            const scores = fullClasses.map((cls, i) => {
                if (firstPage.final_level1 === cls) return (firstPage.final_confidence || 0) * 100;
                return 5; // Valeur minimale pour afficher quelque chose
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: classes,
                    datasets: [{
                        data: scores,
                        backgroundColor: colors,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { display: false }
                        },
                        y: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function createPagesChart() {
            if (!results.pages || results.pages.length <= 1) return;

            const ctx = document.getElementById('pages-chart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: results.pages.map(p => `Page ${p.page || '?'}`),
                    datasets: [{
                        label: 'Confiance',
                        data: results.pages.map(p => (p.final_confidence || 0) * 100),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        function displayPagesDetails() {
            if (!results.pages || results.pages.length <= 1) return;

            const list = document.getElementById('pages-list');
            results.pages.forEach(page => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-3';
                div.innerHTML = `
                    <p class="font-semibold mb-1">Page ${page.page}</p>
                    <p class="text-sm text-gray-600">${page.final_level1 || 'N/A'}</p>
                    <p class="text-xs text-gray-400">${((page.final_confidence || 0) * 100).toFixed(0)}%</p>
                `;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
